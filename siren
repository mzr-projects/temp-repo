{
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        {
          "filterjoin": {
            "indices": ["crime"],
            "on": ["user_id", "user_id"],
            "request": {
              "query": {
                "match_all": {}
              }
            }
          }
        },
        {
          "filterjoin": {
            "indices": ["transfer"],
            "on": ["user_id", "user_id"],
            "request": {
              "query": {
                "term": {
                  "city": "Seattle"
                }
              },
              "aggs": {
                "transfer_count": {
                  "value_count": {
                    "field": "user_id"
                  }
                }
              },
              "post_filter": {
                "script": {
                  "script": {
                    "source": "doc_count > 3"
                  }
                }
              }
            }
          }
        }
      ]
    }
  },
  "aggs": {
    "users": {
      "terms": {
        "field": "user_id",
        "size": 10000
      }
    }
  }
}


######

{ "query": { "bool": { "must": [ { "term": { "name": "John" } }, { "join": { "indices": ["crimes"], "on": ["user_id", "user_id"], "request": { "query": { "match_all": {} } } } }, { "join": { "indices": ["travels"], "on": ["user_id", "user_id"], "request": { "query": { "term": { "destination": "Seattle" } }, "runtime_mappings": { "count_me": { "type": "long", "script": "emit(1L)" } }, "project": [ { "field": { "name": "count_me", "alias": "travel_counts" } } ] } } }, { "script": { "script": { "source": "doc['travel_counts'].size() > 3", "lang": "painless" } } } ] } } }